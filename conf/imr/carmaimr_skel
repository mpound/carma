#!/bin/bash
#
# /etc/rcX.d style script to start IMR or OAD. This script is intended to be ran
# from /etc/init.d or the corresponding rcX.d type startup/shutdown links.
# This script was automatically generated by carma-install-imr. 
# 
# Please note that this script differs from the carma-imr script which is used
# for starting the IMR with a notification server and nameserver only!
#
# Author:       Andrew Beard
#
IMR=IMRHOST_FROM_CONF
XML_FILE=XMLFILE_FROM_CONF
INSTALL=PREFIX_FROM_CONF
OAD=`hostname`

RETVAL=1

. /etc/init.d/functions

# See how we were called.
case "$1" in
  start)
    # Check if the IMR is already running
    if [ ! -f /var/lock/subsys/carmaimr ]; then
        # Start the IMR 
        $INSTALL/scripts/imrsetup --imr $IMR --file $XML_FILE start
        RETVAL=$?
        # If it was successful - set a lock in /var/lock/subsy
        [ $RETVAL -eq 0 ] && touch /var/lock/subsys/carmaimr
    else
        echo "IMR is already started" 
    fi
    
    if (( $RETVAL == 0)); then
        action $"Starting IMR: " /bin/true
    else
        action $"Starting IMR: " /bin/false
    fi
	;;
  stop)
    # Kill the IMR or OAD differently depending on which it is
        $INSTALL/scripts/imrsetup --imr $IMR --file $XML_FILE stop
        RETVAL=$?
        if (( $RETVAL == 0)); then
	    rm -f /var/lock/subsys/carmaimr
            action $"Stopping IMR: " /bin/true
        else 
            action $"Stopping IMR: " /bin/false
        fi
	;;
  status)
    echo "IMR Status:"
    $INSTALL/scripts/imrsetup --imr $IMR --file $XML_FILE status
	;;
  restart|reload)
    $INSTALL/scripts/imrsetup --imr $IMR --file $XML_FILE restart
    :
	;;
  *)
	# do not advertise unreasonable commands that there is no reason
	# to use with this device
	echo $"Usage: $0 {start|stop|status|restart|reload}"
	exit 1
esac

exit 0
