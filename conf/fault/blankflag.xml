<?xml version="1.0" standalone="no"?>
<!DOCTYPE dag SYSTEM "blankflag.dtd" [
	<!ENTITY SCI1 "1">
	<!ENTITY SCI2 "2">
	<!ENTITY SLCBANDS "8">
	<!ENTITY WBCBANDS "16">
	<!ENTITY SLCINPUTS "15">
	<!ENTITY WBCINPUTS "8">
]>

<dag type="blankflag">

	<!-- pre-define antenna specific monitor points: each antenna is one standalone group -->
	<range var="carmaAntNo" first="1" last="23">
		<gather name="antenna(carmaAntNo)_gather">
			<!-- require valid subsystem data -->
			<mp canon="(antSubsys:carmaAntNo).MonitorSubsystemStats.validSubsystem" bit="MONITORDATA">
				<!-- drive system -->
				<mp canon="(antSubsys:carmaAntNo).AntennaCommon.Drive.state" bit="DRIVE" />

				<!-- receiver system -->
				<mp canon="(antSubsys:carmaAntNo).AntennaCommon.LO.yigState" bit="PHASELOCK">
					<mp canon="(antSubsys:carmaAntNo).AntennaCommon.LO.loState" bit="PHASELOCK" />
				</mp>
			</mp>
		</gather>
	</range>

	<!-- blanking and flagging outputs (astroband numbered) -->
	<range var="bandNoVar" first="1" last="24">
		<range var="inputNoVar" first="1" last="32">
			<bf_output astroband="(bandNoVar)" astroinput="(inputNoVar)">

				<varmap_scope var="carmaAntNo" canon="SignalPath.Mapping.Astroband(bandNoVar).Input(inputNoVar).antennaNo">
				<varmap_scope var="corrBandNo" canon="SignalPath.Mapping.Astroband(bandNoVar).Input(inputNoVar).corrBandNo">
				<varmap_scope var="corrBandInputNo" canon="SignalPath.Mapping.Astroband(bandNoVar).Input(inputNoVar).corrBandInputNo">

				<!--
					 This variable is used during the traversal of the per-antenna state
					 to choose which subarray transient state(s) to pick.
				-->
				<varmap_scope var="corrSubarrayNo" canon="SignalPath.Mapping.Astroband(bandNoVar).subarrayNo">

					<!--
						 If this antenna is not being controlled by the same subarray as
						 the correlator band to which it is connected, we must blank it
						 for the pipeline.

						 This handles the special case where the hardware is all physically wired
						 together (antenna receiver, switchyard, dcons, correlator) however the
						 antenna is not being controlled by the same subarray controlling the
						 correlator. In this case, the antenna may be pointed at a completely
						 different place on the sky.
					-->
					<if canon="Control.Antenna(carmaAntNo).subarrayNumber" val="(corrSubarrayNo)" negate="true">
						<bad bit="OFFLINE" />
					</if>

					<!-- per-antenna state -->
					<transient cond="correlatorNoiseOff" subarray="(corrSubarrayNo)">
						<gather_ref name="antenna(carmaAntNo)_gather" />
					</transient>

				</varmap_scope>
				</varmap_scope>
				</varmap_scope>
				</varmap_scope>

			</bf_output>
		</range>
	</range>

</dag>
<!-- vim: set ts=4 sts=4 sw=4 noet: -->
